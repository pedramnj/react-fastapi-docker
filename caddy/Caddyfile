# Caddyfile - Automatic HTTPS with Let's Encrypt

{
    email pedram@pedramcv.me
    acme_ca https://acme-v02.api.letsencrypt.org/directory
}

pedramcv.me {
    # Grafana dashboard - allow iframe embedding
    handle /grafana/* {
        reverse_proxy grafana:3000 {
            header_down -X-Frame-Options
        }
    }

    # Prometheus metrics (internal only - remove in production)
    handle /prometheus/* {
        uri strip_prefix /prometheus
        reverse_proxy prometheus:9090
    }

    # Backend metrics endpoint
    handle /metrics {
        reverse_proxy backend:8000
    }

    # API routes to backend
    handle /api/* {
        reverse_proxy backend:8000
    }

    # Health check endpoint
    handle /health {
        reverse_proxy backend:8000
    }

    # Frontend - React app (default)
    handle {
        reverse_proxy frontend:80
    }

    encode gzip

    header {
        X-Content-Type-Options nosniff
        Referrer-Policy strict-origin-when-cross-origin
        -Server
    }

    # Add X-Frame-Options only to non-monitoring paths
    @notMonitoring {
        not path /grafana/* /prometheus/*
    }
    header @notMonitoring X-Frame-Options SAMEORIGIN

    log {
        output stdout
        format json
    }
}

www.pedramcv.me {
    redir https://pedramcv.me{uri} permanent
}
